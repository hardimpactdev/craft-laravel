name: Integration Tests

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'resources/stubs/**'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-auth:
    name: Test Auth Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout craft-laravel
        uses: actions/checkout@v4
        with:
          path: craft-laravel

      - name: Checkout craft-starterkit
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/craft-starterkit
          token: ${{ secrets.GH_PAT }}
          path: starterkit

      - name: Checkout waymaker
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/waymaker
          token: ${{ secrets.GH_PAT }}
          path: waymaker

      - name: Checkout laravel-toolbar
        uses: actions/checkout@v4
        with:
          repository: nckrtl/laravel-toolbar
          token: ${{ secrets.GH_PAT }}
          path: laravel-toolbar

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
          coverage: none

      - name: Configure composer repositories
        working-directory: starterkit
        run: |
          composer config repositories.waymaker path ../waymaker
          composer config repositories.craft-laravel path ../craft-laravel
          composer config repositories.laravel-toolbar path ../laravel-toolbar

      - name: Install dependencies
        working-directory: starterkit
        run: composer install --no-interaction --prefer-dist

      - name: Setup environment
        working-directory: starterkit
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Run auth setup
        working-directory: starterkit
        run: php artisan craft:setup auth

      - name: Verify auth files
        working-directory: starterkit
        run: |
          # Fortify provider and config
          test -f app/Providers/FortifyServiceProvider.php
          test -f config/fortify.php
          
          # Fortify actions
          test -f app/Actions/Fortify/CreateNewUser.php
          test -f app/Actions/Fortify/ResetUserPassword.php
          
          # Concerns (validation rules)
          test -f app/Concerns/PasswordValidationRules.php
          test -f app/Concerns/ProfileValidationRules.php
          
          # 2FA Controller
          test -f app/Http/Controllers/Settings/TwoFactorAuthenticationController.php
          
          # Vue auth pages
          test -f resources/js/pages/auth/Login.vue
          test -f resources/js/pages/auth/Register.vue
          test -f resources/js/pages/auth/TwoFactorChallenge.vue
          
          # 2FA components and composable
          test -f resources/js/components/TwoFactorSetupModal.vue
          test -f resources/js/components/TwoFactorRecoveryCodes.vue
          test -f resources/js/composables/useTwoFactorAuth.ts
          
          # Tests
          test -f tests/Feature/Auth/AuthenticationTest.php
          
          # Verify FortifyServiceProvider is registered
          grep -q "FortifyServiceProvider" bootstrap/providers.php
          
          echo "All auth files verified!"

  test-dashboard:
    name: Test Dashboard Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout craft-laravel
        uses: actions/checkout@v4
        with:
          path: craft-laravel

      - name: Checkout craft-starterkit
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/craft-starterkit
          token: ${{ secrets.GH_PAT }}
          path: starterkit

      - name: Checkout waymaker
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/waymaker
          token: ${{ secrets.GH_PAT }}
          path: waymaker

      - name: Checkout laravel-toolbar
        uses: actions/checkout@v4
        with:
          repository: nckrtl/laravel-toolbar
          token: ${{ secrets.GH_PAT }}
          path: laravel-toolbar

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
          coverage: none

      - name: Configure composer repositories
        working-directory: starterkit
        run: |
          composer config repositories.waymaker path ../waymaker
          composer config repositories.craft-laravel path ../craft-laravel
          composer config repositories.laravel-toolbar path ../laravel-toolbar

      - name: Install dependencies
        working-directory: starterkit
        run: composer install --no-interaction --prefer-dist

      - name: Setup environment
        working-directory: starterkit
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Run dashboard setup
        working-directory: starterkit
        run: php artisan craft:setup dashboard

      - name: Verify dashboard files
        working-directory: starterkit
        run: |
          test -f app/Http/Controllers/DashboardController.php
          test -f app/Http/Controllers/Settings/ProfileController.php
          test -f resources/js/pages/Dashboard.vue
          test -f resources/js/pages/settings/Profile.vue
          test -f tests/Feature/DashboardTest.php
          echo "All dashboard files verified!"

  test-app:
    name: Test App Setup (Auth + Dashboard)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout craft-laravel
        uses: actions/checkout@v4
        with:
          path: craft-laravel

      - name: Checkout craft-starterkit
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/craft-starterkit
          token: ${{ secrets.GH_PAT }}
          path: starterkit

      - name: Checkout waymaker
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/waymaker
          token: ${{ secrets.GH_PAT }}
          path: waymaker

      - name: Checkout laravel-toolbar
        uses: actions/checkout@v4
        with:
          repository: nckrtl/laravel-toolbar
          token: ${{ secrets.GH_PAT }}
          path: laravel-toolbar

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
          coverage: none

      - name: Configure composer repositories
        working-directory: starterkit
        run: |
          composer config repositories.waymaker path ../waymaker
          composer config repositories.craft-laravel path ../craft-laravel
          composer config repositories.laravel-toolbar path ../laravel-toolbar

      - name: Install dependencies
        working-directory: starterkit
        run: composer install --no-interaction --prefer-dist

      - name: Setup environment
        working-directory: starterkit
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Run app setup
        working-directory: starterkit
        run: php artisan craft:setup app

      - name: Verify app files (auth + dashboard)
        working-directory: starterkit
        run: |
          # Auth (Fortify-based)
          test -f app/Providers/FortifyServiceProvider.php
          test -f config/fortify.php
          test -f app/Actions/Fortify/CreateNewUser.php
          test -f resources/js/pages/auth/Login.vue
          test -f resources/js/pages/auth/TwoFactorChallenge.vue
          
          # Dashboard
          test -f app/Http/Controllers/DashboardController.php
          test -f resources/js/pages/Dashboard.vue
          
          # Settings (including 2FA)
          test -f resources/js/pages/settings/Profile.vue
          test -f resources/js/pages/settings/TwoFactor.vue
          
          echo "All app files verified!"

  test-cms:
    name: Test CMS Setup
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout craft-laravel
        uses: actions/checkout@v4
        with:
          path: craft-laravel

      - name: Checkout craft-starterkit
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/craft-starterkit
          token: ${{ secrets.GH_PAT }}
          path: starterkit

      - name: Checkout waymaker
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/waymaker
          token: ${{ secrets.GH_PAT }}
          path: waymaker

      - name: Checkout laravel-toolbar
        uses: actions/checkout@v4
        with:
          repository: nckrtl/laravel-toolbar
          token: ${{ secrets.GH_PAT }}
          path: laravel-toolbar

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
          coverage: none

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Configure npm registry auth
        working-directory: starterkit
        run: |
          echo "@hardimpactdev:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GH_PAT }}" >> .npmrc

      - name: Configure composer repositories
        working-directory: starterkit
        run: |
          composer config repositories.waymaker path ../waymaker
          composer config repositories.craft-laravel path ../craft-laravel
          composer config repositories.laravel-toolbar path ../laravel-toolbar

      - name: Install dependencies
        working-directory: starterkit
        run: composer install --no-interaction --prefer-dist

      - name: Setup environment
        working-directory: starterkit
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Run cms setup
        working-directory: starterkit
        run: php artisan craft:setup cms

      - name: Verify cms files
        working-directory: starterkit
        run: |
          test -d app/Filament
          test -f app/Providers/Filament/AdminPanelProvider.php
          test -d resources/css/filament
          grep -q "AdminPanelProvider" bootstrap/providers.php
          echo "All CMS files verified!"

  test-multilanguage:
    name: Test Multilanguage Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout craft-laravel
        uses: actions/checkout@v4
        with:
          path: craft-laravel

      - name: Checkout craft-starterkit
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/craft-starterkit
          token: ${{ secrets.GH_PAT }}
          path: starterkit

      - name: Checkout waymaker
        uses: actions/checkout@v4
        with:
          repository: hardimpactdev/waymaker
          token: ${{ secrets.GH_PAT }}
          path: waymaker

      - name: Checkout laravel-toolbar
        uses: actions/checkout@v4
        with:
          repository: nckrtl/laravel-toolbar
          token: ${{ secrets.GH_PAT }}
          path: laravel-toolbar

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
          coverage: none

      - name: Configure composer repositories
        working-directory: starterkit
        run: |
          composer config repositories.waymaker path ../waymaker
          composer config repositories.craft-laravel path ../craft-laravel
          composer config repositories.laravel-toolbar path ../laravel-toolbar

      - name: Install dependencies
        working-directory: starterkit
        run: composer install --no-interaction --prefer-dist

      - name: Setup environment
        working-directory: starterkit
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Run multilanguage setup
        working-directory: starterkit
        run: php artisan craft:setup multilanguage

      - name: Verify multilanguage files
        working-directory: starterkit
        run: |
          test -d lang/en
          test -d lang/nl
          test -f lang/en/auth.php
          test -f lang/nl/auth.php
          test -f resources/js/pages/TranslationExample.vue
          echo "All multilanguage files verified!"
